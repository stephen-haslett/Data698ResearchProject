---
title: "Data 698 Analytics Masterâ€™s Research Project"
subtitle: "Predicting Winning New York Mega Millions Lottery Numbers"
author: "Richard Zheng, Stephen Haslett"
date: "2/7/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(RCurl)
library(rsample)
library(dplyr)
library(tidyr)
library(lubridate)
library(plotly)
library(ggplot2)
library(forcats)
library(caTools)
library(data.table)
```


```{r dataImport}
megaMillionsDataURL <- "https://data.ny.gov/resource/5xaw-6ayf.csv"
megaMillionsWinningNumbers <- read.csv(textConnection(getURL(megaMillionsDataURL)))

# Add leading zeros to Mega Ball numbers below 10 so we get accurate counts when counting occurrence frequencies.
megaMillionsWinningNumbers$mega_ball <- formatC(x = megaMillionsWinningNumbers$mega_ball, digits = 1, flag = '0', format = 'd')

# In order to acheive consistent results in our training data, we manually split the dataset into training and test sets (70/30 split).
# Using a training/test split function such as "initial_split()" results in inconsistent results everytime the program is run.
trainingData <- megaMillionsWinningNumbers[row.names(megaMillionsWinningNumbers) %in% 1:700, ]
testData <- megaMillionsWinningNumbers[row.names(megaMillionsWinningNumbers) %in% 300+1:nrow(megaMillionsWinningNumbers), ]
```



```{r countOccurrencesOfNumber}
#' Helper function that counts the number of times a given number occurs within a dataframe column.
#'
#' This function takes a number and searches a dataframe column to establish how many
#' occurrences of the provided number occur within the given dataframe column.
#'
#' @param dataFrameColumn The dataframe column in which to search for the number of
#' occurrences of the given number. Must be in the format "dataframe$columnname".
#'
#' @param number Integer: The number for which to search the dataframe column for occurrences.
#'
#' @return Integer: The number of times the given number occurs within the given dataframe column.
#'
#' @export
countOccurrencesOfNumber <- function(dataFrameColumn, number) {
  occurrences <- length(grep(number, dataFrameColumn))
  occurrences <- formatC(x = occurrences, digits = 1, flag = '0', format = 'd')

  return(occurrences)
}
```



```{r countTotalNumberOfOccurrencesByColumn}
#' Helper function that counts the occurrences of individual numbers within a dataframe column.
#'
#' This function takes a dataframe column and counts the occurrences of all indivdual numbers within the column.
#'
#' @param dataFrameColumn The dataframe column in which to count all indivdual number occurrences.
#' Must be in the format "dataframe$columnname".
#'
#' @param columnName String: The name of the column in which to count all indivdual number occurrences.
#'
#' @return Dataframe: A dataframe of all the numbers within the given column and the number of times each
#' number occurs (ordered by number of occurrences).
#'
#' @export
countTotalNumberOfOccurrencesByColumn <- function(dataFrameColumn, columnName) {
  occurrencesWithinColumn <- 0
  occurrenceData <- setNames(data.frame(matrix(ncol = 2)), c('Number', 'Occurrences'))

  # Count occurrences of numbers within the "winning_numbers"" column (number range = 01 to 70).
  if (columnName == 'winning_numbers') {
    winningNumbersRange <- seq(1, 70, +1)
    for (number in winningNumbersRange) {
      if (!is.na(number)) {
        # Add leading zero to numbers below 10.
        if (between(number, 0, 9)) {
          number <- paste0('0', number)
        }

        numberOfOccurrences <- countOccurrencesOfNumber(dataFrameColumn, number)
        occurrenceData[number, ]  <- c(number, numberOfOccurrences)
      }
    }
  }

  # Count occurrences of numbers within the "mega_ball" column (number range = 01 to 25).
  if (columnName == 'mega_ball') {
    megaBallRange <- seq(1, 25, +1)
    for (number in megaBallRange) {
      if (!is.na(number)) {
        # Add leading zero to numbers below 10.
        if (between(number, 0, 9)) {
          number <- paste0('0', number)
        }
        
        numberOfOccurrences <- countOccurrencesOfNumber(dataFrameColumn, number)
        occurrenceData[number, ]  <- c(number, numberOfOccurrences)
      }
    }
  }

  # Count occurrences of numbers within the "multiplier"" column (number range = 2 to 5).
  if (columnName == 'multiplier') {
    multiplierRange <- seq(2, 5, +1)
    for (number in multiplierRange) {
      if (!is.na(number)) {
        numberOfOccurrences <- countOccurrencesOfNumber(dataFrameColumn, number)
        occurrenceData[number, ]  <- c(number, numberOfOccurrences)
      }
    }
  }

  # Sort results by occurrences in decreasing order.
  occurrenceData <- occurrenceData[order(occurrenceData[,2], decreasing = TRUE),]
  
  # Drop rows containing NAs from the data.
  occurrenceData <- drop_na(occurrenceData)
  
  # Add ranking based on frequency of occurrence (higher frequencies result in higer rankings).
  occurrenceData$Rank <- round(rank(occurrenceData$Occurrences), 0)

  return(occurrenceData)
}
```



```{r, calculatePayout}
#' TODO: NEED TO ADD MULTIPLIER PARAMETER AND LOGIC TO THIS FUNCTION.
#'
#' Helper function that calculates the payout for a lottery game based on the amount of matching numbers obtained.
#'
#' @param matchingNumberCount Integer: Total count of winning numbers that were matched in a lottery game.
#'
#' @param megaBallMatch Boolean: TRUE if a megaball was matched in a lottery game, FALSE otherwise.
#'
#' @return Numeric: Total winning dollar amount based on numbers matched.
#'
#' @export
calculateTotalPayout <- function(matchingNumberCount, megaBallMatch) {
  # No matching numbers results in a zero dollar payout.
  payout = 0
  
  # Jackpot payout - 75% of the total prize money. 5 matching numbers with the Mega Ball.
  if (matchingNumberCount == 5 && isTRUE(megaBallMatch)) {
    # TODO NEED TO ADD CODE TO CALCULATE THIS VALUE - SETTING TO LARGE NUMBER FOR NOW!!!!
    payout = 1000000000000000
  }

  # Second prize - $1,000,000. 5 matching numbers.
  if (matchingNumberCount == 5 && isFALSE(megaBallMatch)) {
    payout = 1000000
  }
  
  # Third prize - $10,000. 4 matching numbers with the Mega Ball.
  if (matchingNumberCount == 4 && isTrue(megaBallMatch)) {
    payout = 10000
  }
  
  # Fourth prize - $500. 4 matching numbers.
  if (matchingNumberCount == 4 && isFALSE(megaBallMatch)) {
    payout = 500
  }
  
  # Fifth prize - $200. 3 matching numbers with the Mega Ball.
  if (matchingNumberCount == 3 && isTRUE(megaBallMatch)) {
    payout = 200
  }
  
  # Sixth prize - $10. 3 matching numbers.
  if (matchingNumberCount == 3 && isFALSE(megaBallMatch)) {
    payout = 10
  }
  
  # Seventh prize - $10. 2 matching numbers with the Mega Ball.
  if (matchingNumberCount == 2 && isTRUE(megaBallMatch)) {
    payout = 10
  }
  
  # Eighth prize - $4. 1 matching number with the Mega Ball.
  if (matchingNumberCount == 1 && isTRUE(megaBallMatch)) {
    payout = 4
  }
  
  # Ninth prize - $2. No matching numbers with the Mega Ball.
  if (matchingNumberCount == 0 && isTRUE(megaBallMatch)) {
    payout = 2
  }
  
  return(payout)
}
```



```{r randomLotteryTicketGenerator}
#' Simulates generating Mega Millions lottery tickets containing random numbers.
#'
#' This function returns a list containing 5 unique numbers from 1 to 70, and 1 number from
#' 1 to 25 in order to simulate a valid Mega Millions lottery ticket. If the "includeMultiplier"
#' parameter is TRUE, a random multiplier number will also be included in the results.
#'
#' @param includeMultiplier Optional Boolean: Whether or not a multiplier number should be included in the results.
#'
#' @return List: A list containing 6 (7 if the multplier number is included) random numbers representing
#' a Mega Millions lottery ticket.
#'
#' @export
generateRandomLotteryTickets <- function(includeMultiplier = FALSE) {
  uniqueNumbers <- sample(1:70, 5, replace = FALSE)
  mega_ball <- sample(1:25, 1, replace = FALSE)

  if (isTRUE(includeMultiplier)) {
    multiplier <- sample(2:5, 1, replace = FALSE)
    lotteryTickets <- list(uniqueNumbers, mega_ball, multiplier)
  }
  else {
    lotteryTickets <- list(uniqueNumbers, mega_ball)
  }
 
  return(lotteryTickets)
}
```



```{r, generateFrequencyBasedLotteryTicket}
#' Simulates generating a Mega Millions lottery ticket based on frequently occurring winning numbers.
#'
#' This function generates a lottery ticket consisting of the numbers that occur most frequently in
#' the winning numbers result set.
#'
#' @param trainingData Dataframe: The training data from which to generate frequency based numbers.
#'
#' @return List: A list consisting of the 5 most frequent winning numbers, and the most
#' frequent winning MegaBall.
#'
#' @export
generateFrequencyBasedLotteryTicket <- function(trainingData) {
  # Select the top five most frequently occuring winning numbers.
  winningNumbers <- countTotalNumberOfOccurrencesByColumn(trainingData$winning_numbers, 'winning_numbers')

  winningNumbers <- winningNumbers[1:5, ]$Number
  winningNumbers <- as.numeric(winningNumbers) 

  # Select the most frequently occuring Megaball.
  megaBallNumbers <- countTotalNumberOfOccurrencesByColumn(trainingData$mega_ball, 'mega_ball')
  megaBallNumbers <- megaBallNumbers[which.max(megaBallNumbers$Occurrences), ]$Number
  megaBallNumbers <- as.numeric(megaBallNumbers)
  
  lotteryTickets <- list(winningNumbers, megaBallNumbers)

  return(lotteryTickets)
}
```



```{r, simulateLotteryGame}
#' Simulates playing a lottery game.
#'
#' This function simulates playing lottery numbers against the winning numbers test dataset. 
#'
#' @param ticketNumbers Numeric: The lottery numbers to play against the winning numbers test dataset.
#'
#' @param trainingData Dataframe: The training dataset column in which to count all indivdual number occurrences.
#' Must be in the format "dataframe$columnname".
#'
#' @param testData Dataframe: A test dataset of winning numbers to play against.
#'
#' @param generationMethod String: Method to use for generating lottery ticket numbers.
#' Options: random, frequency, consistent.
#'
#' @return Dataframe: The testData dataframe with total winning number matches, payout, etc., columns attached. 
#'
#' @export
lotteryGameSimulation <- function(ticketNumbers = NULL, trainingData = NULL, testData, generationMethod) {
  # Define an empty vector to store the count of matching numbers we get per lottery game.
  matchingNumbersCount <- c()

  # When "generationMethod" is "frequency", generate numbers based on their frequency
  # of occurence in the training dataset.
  if (generationMethod == 'frequency' && !is.null(trainingData)) {
    lotteryNumbers <- data.frame()
    lotteryNumbers <- colnames('winning_numbers')
    frequencyNumbers <- generateFrequencyBasedLotteryTicket(trainingData)
    # Add leading zeros to mega ball numbers below 10.
    lotteryNumbers$winning_numbers <- formatC(x = frequencyNumbers[[1]], digits = 1, flag = '0', format = 'd')

  }
  
  # When "generationMethod" is "consistent", Validate that the ticketNumbers parameter is
  # passed into the function and set "lotteryNumbers" to the ticketNumbers parameter value.
  if (generationMethod == 'consistent' && !is.null(ticketNumbers)) {
    lotteryNumbers <- data.frame()
    lotteryNumbers <- colnames('winning_numbers')
    lotteryNumbers$winning_numbers <- formatC(x = ticketNumbers, digits = 1, flag = '0', format = 'd')
  }

  # Loop through the winning numbers column for each lottery game in the testData set. 
  for (winningNumbersRow in testData$winning_numbers) {
    # When "generationMethod" is "random", generate random lottery numbers. We do this inside of the
    # for loop so that a random lottery ticket is geerated on each iteration. 
    if (generationMethod == 'random') {
      lotteryNumbers <- data.frame()
      lotteryNumbers <- colnames('winning_numbers')
      random <- generateRandomLotteryTickets()
      lotteryNumbers$winning_numbers <- formatC(x = random[[1]], digits = 1, flag = '0', format = 'd')
    }
  
    # Count how many matching winning numbers we get per lottery game. 
    lotteryGame <- sapply(lotteryNumbers$winning_numbers, function(s) length(grep(s, winningNumbersRow)))
    totalMatches <- sum(lotteryGame)

    # Add winning number matches total to the empty matchingNumbersCount vector
    # so we can add this as a new column to the testData dataset.
    matchingNumbersCount <- append(matchingNumbersCount, totalMatches)
  }
  
  # Format the "draw_date" column into a human readable format, and append
  # additional columns to the testData dataset.
  testData$draw_date <- format(as.Date(testData$draw_date), "%B %d, %Y")
  testData$winning_numbers_matched <- matchingNumbersCount

  return(testData)
}  
```



```{r}
# TODO: THIS IS CODE FOR DEVELOPMENT PURPOSES ONLY SND SHOULD BE REMOVED ONE DEVELOPMENT IS COMPLETE!!! 

const <- c(07, 22, 36, 45, 47)
results <- lotteryGameSimulation(NULL, trainingData, testData, 'frequency')
#results <- lotteryGameSimulation(const, NULL, testData, 'consistent')
#results <- lotteryGameSimulation(NULL, NULL, testData, 'random')

results
```


```{r numberOfOccurrenceBarChart, echo = FALSE, message = FALSE, warning = FALSE}
# TODO: Figure out why last 2 rows of DF do not show in bar chart. 
winningNumbersData <-countTotalNumberOfOccurrencesByColumn(trainingData$winning_numbers, 'winning_numbers')

winningNumbersOccurrenceChart <- winningNumbersData %>%
  plot_ly(x = ~winningNumbersData$Number,
          y = winningNumbersData$Occurrences,
          type = 'bar',
          color = winningNumbersData$Number, colors = c('#FA8072'),
          showlegend = FALSE,
          orientation = 'v') %>%
  layout(title = list(text = 'Occurrences Of Winning Numbers', font = list(size = 12)),
    xaxis = list(
      title = 'Winning Number'
    ),
    yaxis = list(
      title = 'Total Occurrences'
    )
  )

subplot(winningNumbersOccurrenceChart)   
```



```{r megaBallOccurrenceBarChart, echo = FALSE, message = FALSE, warning = FALSE}
# TODO: Figure out why last 2 rows of DF do not show in bar chart. 
megaBallData <-countTotalNumberOfOccurrencesByColumn(trainingData$mega_ball, 'mega_ball')

megaBallOccurrenceChart <- megaBallData %>%
  plot_ly(x = ~megaBallData$Number,
          y = megaBallData$Occurrences,
          type = 'bar',
          color = megaBallData$Number, colors = c('#DC143C'),
          showlegend = FALSE,
          orientation = 'v') %>%
  layout(title = list(text = 'Occurrences Of Mega Ball Numbers', font = list(size = 12)),
    xaxis = list(
      title = 'Mega Ball'
    ),
    yaxis = list(
      title = 'Total Occurrences'
    )
  )

subplot(megaBallOccurrenceChart)
```



