---
title: "Data 698 Analaytics Masterâ€™s Research Project"
subtitle: "Predicting Winning New York Mega Millions Lottery Numbers"
author: "Stephen Haslett, Richard Zheng"
date: "2/7/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(RCurl)
library(rsample)
library(dplyr)
library(tidyr)
library(plotly)
library(ggplot2)
library(forcats)
```


```{r dataImport}
megaMillionsDataURL <- "https://data.ny.gov/resource/5xaw-6ayf.csv"
megaMillionsWinningNumbers <- read.csv(textConnection(getURL(megaMillionsDataURL)))

# Split the data into train/test sets (70/30 split).
dataSplit <- initial_split(megaMillionsWinningNumbers, prop = .70)
trainingData <- training(dataSplit)
testData <- testing(dataSplit)
```

```{r randomLotteryTicketGenerator}
#' Simulates generating Mega Millions lottery tickets containing random numbers.
#'
#' This function returns a matrix of rows containing 5 unique numbers from 1 to 70,
#` and 1 number from 1 to 25 in order to simulate a valid Mega Millions lottery ticket. If the
#' "includeMultiplier" parameter is TRUE, a random multiplier number will also be included in the results.
#'
#' @param numberOfTickets Integer: The number of lottery tickets to generate (number of repetitions).
#'
#' @param includeMultiplier Optional Boolean: Whether or not a multiplier number should be included in the results.
#'
#' @return Matrix: A matrix of rows containing 6 (7 if the multplier number is included) random numbers representing
#' a Mega Millions lottery ticket.
#'
#' @export
generateRandomLotteryTickets <- function(numberOfTickets, includeMultiplier = FALSE) {
  uniqueNumbers <- t(replicate(numberOfTickets, sample(1:70, 5, replace = FALSE)))
  megaball <- replicate(numberOfTickets, sample(1:25, 1, replace = FALSE))

  if (isTRUE(includeMultiplier)) {
    multiplier <- replicate(numberOfTickets, sample(2:5, 1, replace = FALSE))
    lotteryTickets <- cbind(uniqueNumbers, megaball, multiplier)
  }
  else {
    lotteryTickets <- cbind(uniqueNumbers, megaball)
  }

  return(lotteryTickets)
}
```


```{r countOccurrencesOfNumber}
#' Counts the number of times a given number occurs within a dataframe column.
#'
#' This function takes a number and searches a dataframe to establish how many
#' occurrences of that number occur within the given dataframe column.
#'
#' @param dataFrameWithColumnName The name of the dataframe column in which to search for
#' the number of occurrences of the given number. Must be in the format "dataframe$columnname".
#'
#' @param number Integer: The number for which to search the dataframe column for occurrences.
#'
#' @return Integer: The number of times the given number occurs within the given dataframe column.
#'
#' @export
countOccurrencesOfNumber <- function(dataFrameWithColumnName, number) {
  occurrences <- length(grep(number, dataFrameWithColumnName))

  return(occurrences)
}
```


```{r countTotalNumberOfOccurrencesByColumn}
#' Counts the occurrences of individual numbers within a dataframe column.
#'
#' This function takes a dataframe column and counts the occurrences of all indivdual numbers within the column.
#'
#' @param dataFrameWithColumnName The dataframe column in which to count all indivdual number occurrences.
#' Must be in the format "dataframe$columnname".
#'
#' @param columnName String: The name of the column in which to count all indivdual number occurrences.
#'
#' @return Dataframe: A dataframe of all the numbers within the given column and the number of times each
#' number occurs (ordered by number of occurrences).
#'
#' @export
countTotalNumberOfOccurrencesByColumn <- function(dataFrameWithColumnName, columnName) {
  occurrencesWithinColumn <- 0
  occurrenceData <- setNames(data.frame(matrix(ncol = 2)), c('Number', 'Occurrences'))

  # Count occurrences of numbers within the "winning_numbers column (number range = 01 to 70).
  if (columnName == 'winning_numbers') {
    winningNumbersRange <- seq(1, 70, +1)
    for (number in winningNumbersRange) {
      if (!is.na(number)) {
        # Add leading zero to numbers below 10.
        if (between(number, 0, 9)) {
          number <- paste0('0', number)
        }

        numberOfOccurrences <- countOccurrencesOfNumber(dataFrameWithColumnName, number)
        occurrenceData[number, ]  <- c(number, numberOfOccurrences)
      }
    }
  }

  # Count occurrences of numbers within the "mega_ball" column (number range = 01 to 25).
  if (columnName == 'mega_ball') {
    megaBallRange <- seq(1, 25, +1)
    for (number in megaBallRange) {
      if (!is.na(number)) {
        # Add leading zero to numbers below 10.
        if (between(number, 0, 9)) {
          number <- paste0('0', number)
        }

        numberOfOccurrences <- countOccurrencesOfNumber(dataFrameWithColumnName, number)
        occurrenceData[number, ]  <- c(number, numberOfOccurrences)
      }
    }
  }

  # Count occurrences of numbers within the "multiplier"" column (number range = 2 to 5).
  if (columnName == 'multiplier') {
    multiplierRange <- seq(2, 5, +1)
    for (number in multiplierRange) {
      if (!is.na(number)) {
        numberOfOccurrences <- countOccurrencesOfNumber(dataFrameWithColumnName, number)
        occurrenceData[number, ]  <- c(number, numberOfOccurrences)
      }
    }
  }

  # Sort results by occurrences in decreasing order.
  occurrenceData <- occurrenceData[order(occurrenceData[,2], decreasing = TRUE),]
  
  # Drop rows containing NAs from the data.
  occurrenceData <- drop_na(occurrenceData)
  
  # Add ranking based on frequency of occurrence (higher frequencies result in higer rankings).
  occurrenceData$Rank <- round(rank(occurrenceData$Occurrences), 0)

  return(occurrenceData)
}
```



```{r numberOccurrenceBarChart}
winningNumbersData <-countTotalNumberOfOccurrencesByColumn(trainingData$winning_numbers, 'winning_numbers')
winningNumbersData

winningNumbersOccurrenceChart <- winningNumbersData  %>%
  plot_ly(x = ~winningNumbersData$Number,
          y = winningNumbersData$Occurrences,
          type = 'bar',
          color = '#A52A2A',
          orientation = 'v') %>%
  layout(title = list(text = 'Occurrences Of Winning Numbers', font = list(size = 12)),
    xaxis = list(
      title = 'Winning Number'
    ),
    yaxis = list(
      title = 'Total Occurrences'
    )
  )

subplot(winningNumbersOccurrenceChart)   

```