---
title: "Lottery Simulations"
author: "Richard Zheng, Stephen Haslett"
date: "2/7/2022"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
library(tidyverse)
library(kableExtra)
```


```{r, helperFunctions, echo = FALSE, message = FALSE, warning = FALSE}
#' Simulates generating Mega Millions lottery tickets containing random numbers.
#'
#' This function returns a list containing 5 unique numbers from 1 to 70, and 1 number from
#' 1 to 25 for the Megaball, in order to simulate a valid Mega Millions lottery ticket.
#'
#' @param numbers Numeric: Random numbers to be used for the ticket base numbers.
#'
#' @param megaball Numeric: Random number to be used for the Mega Ball.
#'
#' @return List: A list containing 7 random numbers representing a Mega Millions lottery ticket.
#'
#' @export
random_ticket_generator = function(numbers, megaball) {
  ticket = sample(numbers, 5, replace = FALSE)
  ball = sample(megaball, 1, replace = FALSE)
  return(list('numbers' = ticket, 'megaball' = ball))
}
  

#' Calculates the cost of a lottery ticket.
#'
#' @param multiplier Optional Boolean: TRUE if the multiplier cost should be applied to the ticket cost, FALSE otherwise.
#'
#' @return List: A list containing the cost of a lottery ticket.
#'
#' @export
calculate_ticket_cost = function(multiplier = FALSE) {
  cost = 2
  multi = 1
  if (multiplier == TRUE) {
    cost = cost + 1
    multi = sample(2:5, 1)
  }
  return(list('cost' = cost,'multiplier' = multi))
}


#' Compares simulated lottery ticket numbers with winning numbers to calculate the amount of matching numbers present.
#'
#' @param ticket Numeric: The lottery ticket numbers under comparison.
#'
#' @param win_nums Numeric: The winning lottery numbers to compare against.
#'
#' @return List: A list containing the total number of matching base and mega ball numbers.
#'
#' @export
numbers_matched = function(ticket, win_nums) {
  megaball = 0
  matched = 0
  if (ticket$megaball == win_nums$megaball) {
    megaball = 1
  }
  for (num in ticket$numbers) {
    for (target in win_nums$numbers) {
      if (num == target) {
        matched = matched + 1
      }
    }
  }
  return(list('match'= matched,'megaball'= megaball))
}


#' Calculates the payout for a lottery game based on the amount of matching numbers obtained.
#'
#' @param num_match Numeric: The number of matching winning numbers.
#'
#' @param mega_match Boolean: TRUE if the Mega Ball was matched, FALSE otherwise.
#'
#' @return Numeric: Total winning dollar amount based on numbers matched.
#'
#' @export
calculate_winnings = function(num_match, mega_match) {
  if (mega_match == 1) {
    if (num_match == 0) {
      return(2)
    }
    else if (num_match == 1) {
      return(4)
    }
    else if (num_match == 2) {
      return(10)
    }
    else if (num_match == 3) {
      return(200)
    }
    else if (num_match == 4) {
      return(10000)
    }
    else {
      return(10000000)  
    }
  }
  else {
    if (num_match < 3) {
      return(0)
    }
    else if (num_match == 3) {
      return(10)
    }
    else if (num_match == 4) {
      return(500)
    }
    else {
      return(1000000)
    }
  }
}
```


```{r, numbers, echo = FALSE, message = FALSE, warning = FALSE}
#' Generates and returns a lottery ticket along with its cost.
#'
#' @param numbers Numeric: The base numbers to be included in the ticket.
#'
#' @param megaball Numeric: The Mega Ball number to be included in the ticket..
#'
#' @return List: A list containing ticket base numbers, Mega Ball, ticket cost,
#' and multiplier number when "multi" is equal to TRUE.
#'
#' @export
ticket_generator = function(numbers, megaball, multi = FALSE) {
  ticket = random_ticket_generator(numbers, megaball)
  ticket_cost = calculate_ticket_cost(multiplier = multi)
  return(c(ticket, ticket_cost))
}


#' Responsible for generating the winning numbers against which lottery tickets are compared.
#'
#' @return List: A list of simulated winning numbers.
#'
#' @export
winning_numbers_generator = function() {
  return (ticket_generator(1:70, 1:25, multi = TRUE))
}
```

Base case: Consistent Numbers Strategy.

```{r, sameTicket, echo = FALSE, message = FALSE, warning = FALSE}
# function that compares a single random ticket to 10000 winning tickets
same_ticket = function(trials, m = FALSE) {
  nums = 0
  megas = 0
  cost = 0
  win = c()
  multiplier = 1
  ticket = ticket_generator(1:70, 1:25, multi = m)
  for (i in 1:trials) {
    winning_numbers = winning_numbers_generator()
    if (m == TRUE) {
      if (winning_numbers$multiplier == ticket$multiplier) {
        multiplier = ticket$multiplier
      }
      else {
        multiplier = 1
      }
    }
    match = numbers_matched(ticket, winning_numbers)
    nums = nums + match$match
    megas = megas + match$megaball
    cost = cost + ticket$cost
    win = c(win, (calculate_winnings(match$match, match$megaball)*multiplier)-ticket$cost)
  }
  return(list('avg_nums' = nums/trials, 'avg_megas' = megas/trials, 'cost' = cost, 'winnings' = win))
}
```

Using a different(random) ticket each time the lottery is pulled


```{r, differentTicket, echo = FALSE, message = FALSE, warning = FALSE}
# function that compares 10000 random tickets to 10000 winning tickets
diff_ticket = function(trials, m = FALSE) {
  nums = 0
  megas = 0
  cost = 0
  win = c()
  multiplier = 1
  for (i in 1:trials) {
    ticket = ticket_generator(1:70, 1:25, multi = m)
    winning_numbers = winning_numbers_generator()
    if (m == TRUE) {
      if (winning_numbers$multiplier == ticket$multiplier) {
        multiplier = ticket$multiplier
      }
      else {
        multiplier = 1
      }
    }
    match = numbers_matched(ticket, winning_numbers)
    nums = nums + match$match
    megas = megas + match$megaball
    cost = cost + ticket$cost
    win = c(win, (calculate_winnings(match$match, match$megaball)*multiplier)-ticket$cost)
  }
  return(list('avg_nums' = nums/trials, 'avg_megas' = megas/trials, 'cost' = cost, 'winnings' = win))
}
```

win = total winnings - total cost

```{r, baseCase, echo = FALSE, message = FALSE, warning = FALSE}
base_case = same_ticket(10000, m = FALSE)
base_winnings = base_case$winnings
```


Multiplier vs No Multiplier

Comparing average ticket winnings between base_case and with multiplier, we see that there is a significant difference in winnings (p-value < 0.05). We reject the null hypothesis and find out that using the multiplier is worse than no multiplier (losses are larger)

```{r, tTest, echo = FALSE, message = FALSE, warning = FALSE}
with_multi = same_ticket(10000, m = TRUE)
multi_winnings = with_multi$winnings
multi_test = t.test(base_winnings, multi_winnings, alternative = c('two.sided'))
multi_test
```

Comparing base case to choosing random tickets each lottery, we see that the P value is greater than 0.05 so we cannot reject the null hypothesis. Both scenarios yield the same results.

```{r, randomTTest, echo = FALSE, message = FALSE, warning = FALSE}
with_random = diff_ticket(10000, m = FALSE)
random_winnings = with_random$winnings

random_test = t.test(base_winnings, random_winnings, alternative = c('two.sided'))
random_test
```

## Historical Mega Millions winning numbers data from ny.gov resource.

```{r dataImport, echo = FALSE, message = FALSE, warning = FALSE}
megaMillionsDataURL <- "https://data.ny.gov/resource/5xaw-6ayf.csv"
megaMillionsWinningNumbers <- read.csv(megaMillionsDataURL)
megaMillionsWinningNumbers %>% head()
```

```{r, occurrences, echo = FALSE, message = FALSE, warning = FALSE}
# function that returns a dataframe of winning numbers by count
winningNumberOccurrence = function(winning_tickets) {
  winning_numbers = c()
  for (ticket in winning_tickets) {
    winning_numbers = c(winning_numbers,str_split(ticket, pattern = ' ')[[1]])
  }
  number_counts = data.frame(numbers = winning_numbers) %>%
    group_by(numbers) %>%
    summarize(count = n()) %>%
    arrange(-count)
    
  return(number_counts)
}

# function that returns a dataframe of winning megaballs by count
megaballOccurrence = function(megaballs) {
  number_counts = data.frame(numbers = megaballs) %>%
    group_by(numbers) %>%
    summarize(count = n()) %>%
    arrange(-count)
  
  return(number_counts)
}
```


```{r, hotColdNumbers, echo = FALSE, message = FALSE, warning = FALSE}
# Find hot and cold numbers based on the Mega Millions historical dataset.
# hot number are numbers that appear more than average
# cold number are numbers that appear less than average
number_counts = winningNumberOccurrence(megaMillionsWinningNumbers$winning_numbers)
megaball_counts = megaballOccurrence(megaMillionsWinningNumbers$mega_ball)

hot_numbers = number_counts %>% filter(count >= mean(count))
hot_megaballs = megaball_counts %>% filter(count >= mean(count))

cold_numbers = number_counts %>% filter(count < mean(count))
cold_megaballs = megaball_counts %>% filter(count < mean(count))
```



```{r, barCharts, echo = FALSE, message = FALSE, warning = FALSE, fig.width = 12, fig.height = 7}
# function that plots bar plots in descending order
plot_bar = function(dataset, title) {
  dataset %>%
  ggplot(aes(x = reorder(numbers, -count), y = count, fill = count)) +
  geom_bar(stat = 'identity') +
  labs(x = 'Number', y = 'Count', title = title) +
  theme_minimal() +
  theme(plot.title = element_text(size = 20),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 18))
}

plot_bar(hot_numbers,'Most Recurring Lottery Numbers')
plot_bar(cold_numbers,'Least Recurring Lottery Numbers')
plot_bar(hot_megaballs,'Most Recurring Megaball Numbers')
plot_bar(cold_megaballs,'Least Recurring Megaball Numbers')

```


Hot Hand Fallacy: Numbers that were more successful in the past are more likely to be successful in the future

```{r, hotHandFallacy, echo = FALSE, message = FALSE, warning = FALSE}
# function that compares a single ticket generated by definied choices (for numbers and megaballs) and compares them again 10000 winning tickets
fallacy_cases = function(trials, n_choices, mb_choices, m = FALSE) {
  nums = 0
  megas = 0
  cost = 0
  win = c()
  multiplier = 1
  ticket = ticket_generator(n_choices, mb_choices, multi = m)
  for (i in 1:trials) {
    winning_numbers = winning_numbers_generator()
    if (m == TRUE) {
      if (winning_numbers$multiplier == ticket$multiplier) {
        multiplier = ticket$multiplier
      } else {
        multiplier = 1
      }
    }
    match = numbers_matched(ticket, winning_numbers)
    nums = nums + match$match
    megas = megas + match$megaball
    cost = cost + ticket$cost
    win = c(win, (calculate_winnings(match$match, match$megaball)*multiplier)-ticket$cost)
  }
  
  return(list('avg_nums' = nums/trials, 'avg_megas' = megas/trials, 'cost' = cost, 'winnings' = win))
}

hot_hand = fallacy_cases(10000, hot_numbers$numbers,hot_megaballs$numbers, m = FALSE)
hot_winnings = hot_hand$winnings
hot_hand_test = t.test(base_winnings, hot_winnings, alternative = c('two.sided'))
hot_hand_test
```

Gamblers Fallacy: Belief that occurrences that were less likely to happen in the past are more likely to happen in the future

```{r,  gamblersFallacy, echo = FALSE, message = FALSE, warning = FALSE}
gambler_fallacy = fallacy_cases(10000, cold_numbers$numbers, cold_megaballs$numbers, m = FALSE)
gambler_winnings = gambler_fallacy$winnings
gambler_fallacy_test = t.test(base_winnings, gambler_winnings, alternative = c('two.sided'))
gambler_fallacy_test
```

We are unable to reject the null hypothesis for both gamblers fallacy and hot hand fallacy as the they fall within the expected values of the base case


```{r, comparisonCharts, echo = FALSE, message = FALSE, warning = FALSE}
# function that plots the distribution of the base case and comparison case
compare_dist = function(dist1, dist2, title) {
  colors = c(
    'Base Case' = 'blue',
    'Other Case' = 'red'
  )
  se1 = sd(dist1)/sqrt(length(dist1))
  se2 = sd = sd(dist2)/sqrt(length(dist2))
  normal_dist1 = data.frame(x1 = rnorm(n = 10000, mean = mean(dist1), sd = se1))
  normal_dist2 = data.frame(x1 = rnorm(n = 10000, mean = mean(dist2), sd = se2))
  normal_dist1 %>%
    ggplot(aes(x1, color = 'Base Case')) + geom_histogram(alpha = 0.1, bins = 50) +
    geom_histogram(data = normal_dist2,aes(x1, color = 'Other Case'), alpha = 0.1, bins = 50) +
    labs(x = 'Winnings', y = 'Count', title = title, color = 'Legend') +
    scale_color_manual(values = colors)
}

compare_dist(base_winnings,
             multi_winnings,
            'Base Case Vs Multiplier Strategy')

compare_dist(base_winnings,
             random_winnings,
            'Base Case Vs Random Numbers Strategy')

compare_dist(base_winnings,
             hot_winnings,
            'Base Case Vs Most Frequent Numbers Strategy')

compare_dist(base_winnings,
             gambler_winnings,
            'Base Case Vs Least Frequent Numbers Strategy')
```

```{r, averageWinnings, echo = FALSE, message = FALSE, warning = FALSE}
average_winnings = data.frame(
  c('Consistent Numbers Strategy (_Base Case_)',
    'Multiplier Strategy',
    'Random Numbers Strategy',
    'Most Frequent Numbers Strategy (_Hot Hand Fallacy_)',
    'Least Frequent Numbers Strategy (_Gambler\'s Fallacy_)'),
  c(base_winnings %>% mean(), multi_winnings %>% mean(), random_winnings %>% mean(), hot_winnings %>% mean(), gambler_winnings %>% mean()),
  c(base_winnings %>% sd(), multi_winnings %>% sd(), random_winnings %>% sd(), hot_winnings %>% sd(), gambler_winnings %>% sd())
  )

colnames(average_winnings) = c('Strategy', 'Average Winnings', 'Standard Deviation')

kable(average_winnings, 'html', escape = F, caption = '<center><h3>Average Winnings</h3></center>',
      col.names = c('Strategy', 'Average Winnings', 'Standard Deviation')) %>%
  column_spec(1:3, bold = F) %>%
  kable_styling('striped') %>%
  scroll_box(width = '100%', height = 'auto')

```


